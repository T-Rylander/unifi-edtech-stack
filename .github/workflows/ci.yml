name: CI - Documentation & Scripts

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: node_modules
        continue-on-error: true

  shellcheck:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
        env:
          SHELLCHECK_OPTS: -e SC2034 -e SC2154

  link-check:
    name: Check Markdown Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links in Markdown files
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.markdown-link-check.json'
        continue-on-error: true

  docker-compose-validate:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate docker-compose.yml
        run: |
          cd docker
          docker compose config > /dev/null
        env:
          DOCKER_NETWORK: unifi-net
          WG_PORT: 51820

  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yml
          file_or_dir: docker/docker-compose.yml .github/workflows/
        continue-on-error: true

  status-badge:
    name: Update Status Badge
    runs-on: ubuntu-latest
    needs: [markdown-lint, shellcheck, link-check, docker-compose-validate]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate status
        id: status
        run: |
          if [ "${{ needs.markdown-lint.result }}" == "success" ] && \
             [ "${{ needs.shellcheck.result }}" == "success" ] && \
             [ "${{ needs.docker-compose-validate.result }}" == "success" ]; then
            echo "status=passing" >> $GITHUB_OUTPUT
          else
            echo "status=failing" >> $GITHUB_OUTPUT
          fi

      - name: Create badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: your-gist-id-here
          filename: unifi-edtech-ci.json
          label: CI
          message: ${{ steps.status.outputs.status }}
          color: ${{ steps.status.outputs.status == 'passing' && 'brightgreen' || 'red' }}
